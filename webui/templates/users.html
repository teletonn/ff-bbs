{% extends "base.html" %}

{% block content %}
<!-- Modal for editing user -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <span id="closeEditModal" class="close">&times;</span>
    <h2>Редактировать пользователя</h2>
    <form id="editForm">
      <input type="hidden" id="editUserId" name="id">
      <div style="margin-bottom: 15px;">
        <label for="editUsername">Имя пользователя:</label>
        <input type="text" id="editUsername" name="username" required>
      </div>
      <div style="margin-bottom: 15px;">
        <label for="editNickname">Псевдоним:</label>
        <input type="text" id="editNickname" name="nickname">
      </div>
      <div style="margin-bottom: 15px;">
        <label for="editNodeId">ID узла:</label>
        <input type="text" id="editNodeId" name="node_id" pattern="^\d+$" title="Node ID должен содержать только цифры">
      </div>
      <div style="margin-bottom: 15px;">
        <label for="editEmail">Email:</label>
        <input type="email" id="editEmail" name="email">
      </div>
      <div style="margin-bottom: 15px;">
        <label for="editTelegramId">Telegram ID:</label>
        <input type="number" id="editTelegramId" name="telegram_id">
      </div>
      <div style="margin-bottom: 15px;">
        <label for="editTelegramFirstName">Telegram Имя:</label>
        <input type="text" id="editTelegramFirstName" name="telegram_first_name">
      </div>
      <div style="margin-bottom: 15px;">
        <label for="editTelegramLastName">Telegram Фамилия:</label>
        <input type="text" id="editTelegramLastName" name="telegram_last_name">
      </div>
      <div style="margin-bottom: 15px;">
        <label for="editTelegramUsername">Telegram Username:</label>
        <input type="text" id="editTelegramUsername" name="telegram_username">
      </div>
      <div style="margin-bottom: 15px;">
        <label for="editMeshNodeId">Mesh Node ID:</label>
        <input type="text" id="editMeshNodeId" name="mesh_node_id" pattern="^![0-9a-fA-F]{8}$" title="Mesh Node ID должен быть в формате !12345678 (восклицательный знак, за которым следуют 8 шестнадцатеричных цифр)">
      </div>
      <div style="margin-bottom: 15px;">
        <label for="editIsActive">Активен:</label>
        <input type="checkbox" id="editIsActive" name="is_active" checked>
      </div>
      <div style="margin-bottom: 15px;">
        <label for="editRole">Роль:</label>
        <select id="editRole" name="role">
          <option value="user">Пользователь</option>
          <option value="admin">Администратор</option>
        </select>
      </div>
      <button type="submit">Обновить</button>
    </form>
  </div>
</div>

<!-- Modal for manual user registration -->
<div id="registerModal" class="modal">
  <div class="modal-content">
    <span id="closeRegisterModal" class="close">&times;</span>
    <h2>Регистрация нового пользователя</h2>
    <form id="registerForm">
      <div style="margin-bottom: 15px;">
        <label for="registerUsername">Имя пользователя:</label>
        <input type="text" id="registerUsername" name="username" required>
      </div>
      <div style="margin-bottom: 15px;">
        <label for="registerPassword">Пароль:</label>
        <input type="password" id="registerPassword" name="password" required>
      </div>
      <div style="margin-bottom: 15px;">
        <label for="registerNickname">Псевдоним:</label>
        <input type="text" id="registerNickname" name="nickname">
      </div>
      <div style="margin-bottom: 15px;">
        <label for="registerNodeId">ID узла:</label>
        <input type="text" id="registerNodeId" name="node_id" pattern="^\d+$" title="Node ID должен содержать только цифры">
      </div>
      <div style="margin-bottom: 15px;">
        <label for="registerEmail">Email:</label>
        <input type="email" id="registerEmail" name="email">
      </div>
      <div style="margin-bottom: 15px;">
        <label for="registerTelegramId">Telegram ID:</label>
        <input type="number" id="registerTelegramId" name="telegram_id">
      </div>
      <div style="margin-bottom: 15px;">
        <label for="registerTelegramFirstName">Telegram Имя:</label>
        <input type="text" id="registerTelegramFirstName" name="telegram_first_name">
      </div>
      <div style="margin-bottom: 15px;">
        <label for="registerTelegramLastName">Telegram Фамилия:</label>
        <input type="text" id="registerTelegramLastName" name="telegram_last_name">
      </div>
      <div style="margin-bottom: 15px;">
        <label for="registerTelegramUsername">Telegram Username:</label>
        <input type="text" id="registerTelegramUsername" name="telegram_username">
      </div>
      <div style="margin-bottom: 15px;">
        <label for="registerMeshNodeId">Mesh Node ID:</label>
        <input type="text" id="registerMeshNodeId" name="mesh_node_id" pattern="^![0-9a-fA-F]{8}$" title="Mesh Node ID должен быть в формате !12345678 (восклицательный знак, за которым следуют 8 шестнадцатеричных цифр)">
      </div>
      <div style="margin-bottom: 15px;">
        <label for="registerIsActive">Активен:</label>
        <input type="checkbox" id="registerIsActive" name="is_active" checked>
      </div>
      <button type="submit">Зарегистрировать</button>
    </form>
  </div>
</div>

<!-- Modal for managing user groups -->
<div id="groupsModal" class="modal">
  <div class="modal-content" style="max-width: 600px; max-height: 80%; overflow-y: auto;">
    <span id="closeGroupsModal" class="close">&times;</span>
    <h2>Управление группами для <span id="groupsUserName"></span></h2>
    <input type="hidden" id="groupsUserId">
    <div id="userGroupsList" style="margin-bottom: 20px;">
      <h3>Текущие группы:</h3>
      <div id="currentGroups"></div>
    </div>
    <div>
      <h3>Добавить в группу:</h3>
      <select id="availableGroups">
        <option value="">Выберите группу...</option>
      </select>
      <button id="addToGroupBtn">Добавить</button>
    </div>
  </div>
</div>

<!-- Modal for editing group -->
<div id="editGroupModal" class="modal">
  <div class="modal-content">
    <span id="closeEditGroupModal" class="close">&times;</span>
    <h2 id="groupModalTitle">Создать группу</h2>
    <form id="editGroupForm">
      <input type="hidden" id="editGroupId" name="id">
      <div style="margin-bottom: 15px;">
        <label for="editGroupName">Имя группы:</label>
        <input type="text" id="editGroupName" name="name" required>
      </div>
      <div style="margin-bottom: 15px;">
        <label for="editGroupDescription">Описание:</label>
        <textarea id="editGroupDescription" name="description" style="height: 80px;"></textarea>
      </div>
      <button type="submit">Сохранить</button>
    </form>
  </div>
</div>

<!-- Groups Management Section -->
<div class="glass-card" style="margin-bottom: 30px;">
  <h2>Управление группами</h2>
  <button id="createGroupBtn">Создать новую группу</button>
  <div id="groups-loading" class="loading">Загрузка групп...</div>
  <table id="groups-table" style="display: none;">
    <thead>
      <tr>
        <th>Имя группы</th>
        <th>Описание</th>
        <th>Участники</th>
        <th>Создано</th>
        <th>Действия</th>
      </tr>
    </thead>
    <tbody id="groups-body">
    </tbody>
  </table>
  <div id="no-groups" class="loading" style="display: none;">Группы недоступны</div>
  <div id="groups-error" class="error" style="display: none;">Ошибка загрузки групп</div>
</div>

<!-- Users Management Section -->
<div class="glass-card">
   <h2>Управление пользователями</h2>
   <button id="registerUserBtn">Регистрация нового пользователя</button>
   <div id="loading" class="loading">Загрузка пользователей...</div>
  <table id="users-table" style="display: none;">
    <thead>
      <tr>
        <th>Имя пользователя</th>
        <th>Псевдоним</th>
        <th>ID узла</th>
        <th>Email</th>
        <th>Telegram ID</th>
        <th>Telegram Имя</th>
        <th>Telegram Фамилия</th>
        <th>Telegram Username</th>
        <th>Mesh Node ID</th>
        <th>Активен</th>
        <th>Роль</th>
        <th>Группы</th>
        <th>Создано</th>
        <th>Действия</th>
      </tr>
    </thead>
    <tbody id="users-body">
    </tbody>
  </table>
  <div id="no-users" class="loading" style="display: none;">Пользователи недоступны</div>
  <div id="error" class="error" style="display: none;">Ошибка загрузки пользователей</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // User modal elements
  const editModal = document.getElementById('editModal');
  const closeEditModal = document.getElementById('closeEditModal');
  const editForm = document.getElementById('editForm');

  // Register modal elements
  const registerModal = document.getElementById('registerModal');
  const closeRegisterModal = document.getElementById('closeRegisterModal');
  const registerForm = document.getElementById('registerForm');

  // Groups modal elements
  const groupsModal = document.getElementById('groupsModal');
  const closeGroupsModal = document.getElementById('closeGroupsModal');

  // Group edit modal elements
  const editGroupModal = document.getElementById('editGroupModal');
  const closeEditGroupModal = document.getElementById('closeEditGroupModal');
  const editGroupForm = document.getElementById('editGroupForm');

  // Modal event listeners
  closeEditModal.onclick = () => editModal.style.display = 'none';
  closeRegisterModal.onclick = () => registerModal.style.display = 'none';
  closeGroupsModal.onclick = () => groupsModal.style.display = 'none';
  closeEditGroupModal.onclick = () => editGroupModal.style.display = 'none';

  window.onclick = function(event) {
    if (event.target == editModal) editModal.style.display = 'none';
    if (event.target == registerModal) registerModal.style.display = 'none';
    if (event.target == groupsModal) groupsModal.style.display = 'none';
    if (event.target == editGroupModal) editGroupModal.style.display = 'none';
  }

  // User form submission
  editForm.onsubmit = function(e) {
    e.preventDefault();
    const userId = document.getElementById('editUserId').value;
    const formData = new FormData(editForm);
    const data = {
      username: formData.get('username'),
      nickname: formData.get('nickname') || null,
      node_id: formData.get('node_id') || null,
      email: formData.get('email') || null,
      telegram_id: formData.get('telegram_id') || null,
      telegram_first_name: formData.get('telegram_first_name') || null,
      telegram_last_name: formData.get('telegram_last_name') || null,
      telegram_username: formData.get('telegram_username') || null,
      mesh_node_id: formData.get('mesh_node_id') || null,
      is_active: document.getElementById('editIsActive').checked ? 1 : 0,
      role: formData.get('role')
    };

    fetch(`/api/v1/users/${userId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    })
    .then(res => {
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    })
    .then(result => {
      if (result.success) {
        alert('Пользователь обновлен успешно');
        editModal.style.display = 'none';
        loadUsers();
      } else {
        alert('Обновление не удалось');
      }
    })
    .catch(err => {
      alert('Error: ' + err.message);
    });
  };

  // Register form submission
  registerForm.onsubmit = function(e) {
    e.preventDefault();
    const formData = new FormData(registerForm);
    const data = {
      username: formData.get('username'),
      password: formData.get('password'),
      nickname: formData.get('nickname') || null,
      node_id: formData.get('node_id') || null,
      email: formData.get('email') || null,
      telegram_id: formData.get('telegram_id') || null,
      telegram_first_name: formData.get('telegram_first_name') || null,
      telegram_last_name: formData.get('telegram_last_name') || null,
      telegram_username: formData.get('telegram_username') || null,
      mesh_node_id: formData.get('mesh_node_id') || null,
      is_active: document.getElementById('registerIsActive').checked ? 1 : 0,
      role: 'user'  // Registration always creates users, admin role only via edit
    };

    fetch('/api/v1/users/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    })
    .then(res => {
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    })
    .then(result => {
      if (result.success) {
        alert('Пользователь зарегистрирован успешно');
        registerModal.style.display = 'none';
        registerForm.reset();
        loadUsers();
      } else {
        alert('Регистрация не удалась');
      }
    })
    .catch(err => {
      alert('Error: ' + err.message);
    });
  };

  // Group form submission
  editGroupForm.onsubmit = function(e) {
    e.preventDefault();
    const groupId = document.getElementById('editGroupId').value;
    const formData = new FormData(editGroupForm);
    const data = {
      name: formData.get('name'),
      description: formData.get('description') || ''
    };

    const method = groupId ? 'PUT' : 'POST';
    const url = groupId ? `/api/v1/groups/${groupId}` : '/api/v1/groups';

    fetch(url, {
      method: method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    })
    .then(res => {
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    })
    .then(result => {
      if (result.success || result.id) {
        alert(groupId ? 'Группа обновлена успешно' : 'Группа создана успешно');
        editGroupModal.style.display = 'none';
        loadGroups();
      } else {
        alert('Операция не удалась');
      }
    })
    .catch(err => {
      alert('Error: ' + err.message);
    });
  };

  // Register user button
  document.getElementById('registerUserBtn').onclick = () => {
    registerModal.style.display = 'block';
  };

  // Create group button
  document.getElementById('createGroupBtn').onclick = () => showEditGroupModal();

  // Add to group functionality
  document.getElementById('addToGroupBtn').onclick = function() {
    const userId = document.getElementById('groupsUserId').value;
    const groupId = document.getElementById('availableGroups').value;
    if (!groupId) {
      alert('Пожалуйста, выберите группу');
      return;
    }

    fetch(`/api/v1/users/${userId}/groups/${groupId}`, { method: 'POST' })
    .then(res => {
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    })
    .then(result => {
      if (result.success) {
        alert('Пользователь добавлен в группу успешно');
        loadUserGroups(userId);
        loadAvailableGroups(userId);
        loadUsers(); // Refresh the main table to show updated group assignments
      } else {
        alert('Не удалось добавить пользователя в группу: ' + (result.message || 'Неизвестная ошибка'));
      }
    })
    .catch(err => {
      console.error('Error adding user to group:', err);
      alert('Ошибка при добавлении пользователя в группу: ' + err.message);
    });
  };

  function loadUsers() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('users-table').style.display = 'none';
    document.getElementById('no-users').style.display = 'none';
    document.getElementById('error').style.display = 'none';

    fetch('/api/v1/users')
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}: Failed to fetch users`);
        return res.json();
      })
      .then(data => {
        // Remove duplicate users by ID
        const uniqueUsers = data.filter((user, index, self) =>
          index === self.findIndex(u => u.id === user.id)
        );

        const tbody = document.getElementById('users-body');
        tbody.innerHTML = '';
        if (uniqueUsers.length === 0) {
          document.getElementById('no-users').style.display = 'block';
        } else {
          Promise.all(uniqueUsers.map(user => fetch(`/api/v1/users/${user.id}/groups`).then(res => res.json())))
          .then(groupsData => {
            uniqueUsers.forEach((user, index) => {
              const row = tbody.insertRow();
              row.insertCell(0).textContent = user.username || '';
              row.insertCell(1).textContent = user.nickname || '';
              row.insertCell(2).textContent = user.node_id || '';
              row.insertCell(3).textContent = user.email || '';
              row.insertCell(4).textContent = user.telegram_id || '';
              row.insertCell(5).textContent = user.telegram_first_name || '';
              row.insertCell(6).textContent = user.telegram_last_name || '';
              row.insertCell(7).textContent = user.telegram_username || '';
              row.insertCell(8).textContent = user.mesh_node_id || '';
              row.insertCell(9).textContent = user.is_active ? 'Да' : 'Нет';
              row.insertCell(10).textContent = user.role || '';

              // Groups cell
              const groupsCell = row.insertCell(11);
              const userGroups = groupsData[index] || [];
              groupsCell.textContent = userGroups.map(g => g.name).join(', ') || 'None';

              row.insertCell(12).textContent = user.created_at || '';

              const actionCell = row.insertCell(13);
              const activateBtn = document.createElement('button');
              activateBtn.textContent = user.is_active ? 'Деактивировать' : 'Активировать';
              activateBtn.onclick = () => toggleUserActive(user.id, !user.is_active);
              actionCell.appendChild(activateBtn);

              const editBtn = document.createElement('button');
              editBtn.textContent = 'Edit';
              editBtn.onclick = () => showEditModal(user);
              actionCell.appendChild(editBtn);

              const groupsBtn = document.createElement('button');
              groupsBtn.textContent = 'Groups';
              groupsBtn.onclick = () => showGroupsModal(user);
              actionCell.appendChild(groupsBtn);

              const deleteBtn = document.createElement('button');
              deleteBtn.textContent = 'Delete';
              deleteBtn.onclick = () => deleteUser(user.id);
              actionCell.appendChild(deleteBtn);
            });
            document.getElementById('users-table').style.display = 'table';
          });
        }
        document.getElementById('loading').style.display = 'none';
      })
    .catch(err => {
      console.error('Ошибка загрузки пользователей:', err);
      const errorMsg = err.message || 'Неизвестная ошибка';
      document.getElementById('error').textContent = 'Ошибка загрузки пользователей: ' + errorMsg;
      document.getElementById('error').style.display = 'block';
      document.getElementById('loading').style.display = 'none';
    });
  }

  function loadGroups() {
    document.getElementById('groups-loading').style.display = 'block';
    document.getElementById('groups-table').style.display = 'none';
    document.getElementById('no-groups').style.display = 'none';
    document.getElementById('groups-error').style.display = 'none';

    fetch('/api/v1/groups')
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}: Failed to fetch groups`);
        return res.json();
      })
      .then(data => {
        const tbody = document.getElementById('groups-body');
        tbody.innerHTML = '';
        if (data.length === 0) {
          document.getElementById('no-groups').style.display = 'block';
        } else {
          Promise.all(data.map(group => fetch(`/api/v1/groups/${group.id}/users`).then(res => res.json())))
          .then(membersData => {
            data.forEach((group, index) => {
              const row = tbody.insertRow();
              row.insertCell(0).textContent = group.name || '';
              row.insertCell(1).textContent = group.description || '';

              // Members cell
              const membersCell = row.insertCell(2);
              const members = membersData[index] || [];
              membersCell.textContent = members.length > 0 ? `${members.length} members` : 'No members';

              row.insertCell(3).textContent = group.created_at || '';

              const actionCell = row.insertCell(4);
              const editBtn = document.createElement('button');
              editBtn.textContent = 'Edit';
              editBtn.onclick = () => showEditGroupModal(group);
              actionCell.appendChild(editBtn);

              const deleteBtn = document.createElement('button');
              deleteBtn.textContent = 'Delete';
              deleteBtn.onclick = () => deleteGroup(group.id);
              actionCell.appendChild(deleteBtn);
            });
            document.getElementById('groups-table').style.display = 'table';
          });
        }
        document.getElementById('groups-loading').style.display = 'none';
      })
      .catch(err => {
        console.error('Ошибка загрузки групп:', err);
        const errorMsg = err.message || 'Неизвестная ошибка';
        document.getElementById('groups-error').textContent = 'Ошибка загрузки групп: ' + errorMsg;
        document.getElementById('groups-error').style.display = 'block';
        document.getElementById('groups-loading').style.display = 'none';
      });
  }

  function showEditModal(user) {
    document.getElementById('editUserId').value = user.id;
    document.getElementById('editUsername').value = user.username || '';
    document.getElementById('editNickname').value = user.nickname || '';
    document.getElementById('editNodeId').value = user.node_id || '';
    document.getElementById('editEmail').value = user.email || '';
    document.getElementById('editTelegramId').value = user.telegram_id || '';
    document.getElementById('editTelegramFirstName').value = user.telegram_first_name || '';
    document.getElementById('editTelegramLastName').value = user.telegram_last_name || '';
    document.getElementById('editTelegramUsername').value = user.telegram_username || '';
    document.getElementById('editMeshNodeId').value = user.mesh_node_id || '';
    document.getElementById('editIsActive').checked = user.is_active || false;
    document.getElementById('editRole').value = user.role || 'user';
    editModal.style.display = 'block';
  }

  function showGroupsModal(user) {
    document.getElementById('groupsUserId').value = user.id;
    document.getElementById('groupsUserName').textContent = user.username;
    loadUserGroups(user.id);
    loadAvailableGroups(user.id);
    groupsModal.style.display = 'block';
  }

  function showEditGroupModal(group = null) {
    document.getElementById('editGroupId').value = group ? group.id : '';
    document.getElementById('editGroupName').value = group ? group.name || '' : '';
    document.getElementById('editGroupDescription').value = group ? group.description || '' : '';
    document.getElementById('groupModalTitle').textContent = group ? 'Edit Group' : 'Create Group';
    editGroupModal.style.display = 'block';
  }

  function loadUserGroups(userId) {
    fetch(`/api/v1/users/${userId}/groups`)
    .then(res => res.json())
    .then(groups => {
      const container = document.getElementById('currentGroups');
      container.innerHTML = '';
      if (groups.length === 0) {
        container.innerHTML = '<p>Группы не назначены</p>';
      } else {
        groups.forEach(group => {
          const groupDiv = document.createElement('div');
          groupDiv.className = 'glass-card';
          groupDiv.style = 'display: flex; justify-content: space-between; align-items: center; padding: 10px; margin-bottom: 5px;';
          groupDiv.innerHTML = `
            <span>${group.name}</span>
            <button onclick="removeFromGroup(${userId}, ${group.id})">Remove</button>
          `;
          container.appendChild(groupDiv);
        });
      }
    });
  }

  function loadAvailableGroups(userId) {
    Promise.all([
      fetch('/api/v1/groups').then(res => res.json()),
      fetch(`/api/v1/users/${userId}/groups`).then(res => res.json())
    ])
    .then(([allGroups, userGroups]) => {
      const userGroupIds = userGroups.map(g => g.id);
      const availableGroups = allGroups.filter(g => !userGroupIds.includes(g.id));

      const select = document.getElementById('availableGroups');
      select.innerHTML = '<option value="">Select a group...</option>';
      availableGroups.forEach(group => {
        const option = document.createElement('option');
        option.value = group.id;
        option.textContent = group.name;
        select.appendChild(option);
      });
    });
  }

  // Global function for removing from group
  window.removeFromGroup = function(userId, groupId) {
    if (!confirm('Удалить пользователя из этой группы?')) return;
    fetch(`/api/v1/users/${userId}/groups/${groupId}`, { method: 'DELETE' })
    .then(res => {
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    })
    .then(result => {
      if (result.success) {
        alert('Пользователь удален из группы успешно');
        loadUserGroups(userId);
        loadAvailableGroups(userId);
        loadUsers(); // Refresh the main table to show updated group assignments
      } else {
        alert('Не удалось удалить пользователя из группы: ' + (result.message || 'Неизвестная ошибка'));
      }
    })
    .catch(err => {
      console.error('Error removing user from group:', err);
      alert('Ошибка при удалении пользователя из группы: ' + err.message);
    });
  };

  function toggleUserActive(userId, isActive) {
    const action = isActive ? 'активировать' : 'деактивировать';
    if (!confirm(`Вы уверены, что хотите ${action} этого пользователя?`)) return;
    fetch(`/api/v1/users/${userId}/toggle_active`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ is_active: isActive ? 1 : 0 })
    })
    .then(res => {
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    })
    .then(result => {
      if (result.success) {
        alert(`Пользователь ${action} успешно`);
        loadUsers();
      } else {
        alert(`Не удалось ${action} пользователя`);
      }
    })
    .catch(err => {
      alert('Error: ' + err.message);
    });
  }

  function deleteUser(userId) {
    if (!confirm('Вы уверены, что хотите удалить этого пользователя?')) return;
    fetch(`/api/v1/users/${userId}`, { method: 'DELETE' })
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
      })
      .then(result => {
        if (result.success) {
          alert('Пользователь удален успешно');
          loadUsers();
        } else {
          alert('Удаление не удалось');
        }
      })
      .catch(err => {
        alert('Error: ' + err.message);
      });
  }

  function deleteGroup(groupId) {
    if (!confirm('Вы уверены, что хотите удалить эту группу? Это удалит все назначения пользователей.')) return;
    fetch(`/api/v1/groups/${groupId}`, { method: 'DELETE' })
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
      })
      .then(result => {
        if (result.success) {
          alert('Группа удалена успешно');
          loadGroups();
          loadUsers(); // Refresh users table to update group assignments
        } else {
          alert('Delete failed');
        }
      })
      .catch(err => {
        alert('Error: ' + err.message);
      });
  }

  // Initial load
  loadUsers();
  loadGroups();
  // No auto-refresh for users/groups, as it's admin action
});
</script>
{% endblock %}