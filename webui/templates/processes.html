{% extends "base.html" %}

{% block content %}
<!-- Modal for creating/editing process -->
<div id="editModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
  <div style="background-color: white; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px;">
    <span id="closeEditModal" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
    <h2 id="modalTitle">Создать автоматизированный процесс</h2>
    <form id="editForm">
      <input type="hidden" id="editProcessId" name="id">
      <div style="margin-bottom: 15px;">
        <label for="editName">Имя:</label>
        <input type="text" id="editName" name="name" required style="width: 100%; padding: 8px; box-sizing: border-box;">
      </div>
      <div style="margin-bottom: 15px;">
        <label for="editCommand">Команда:</label>
        <textarea id="editCommand" name="command" required placeholder="system_status" style="width: 100%; padding: 8px; box-sizing: border-box; height: 60px; font-family: monospace;"></textarea>
      </div>
      <div style="margin-bottom: 15px;">
        <label for="editSchedule">Расписание (формат cron):</label>
        <input type="text" id="editSchedule" name="schedule" required placeholder="*/5 * * * *" style="width: 100%; padding: 8px; box-sizing: border-box;">
        <small style="color: #666;">Примеры: "*/5 * * * *" (каждые 5 мин), "0 */1 * * *" (ежечасно), "0 0 * * *" (ежедневно)</small>
      </div>
      <div style="margin-bottom: 15px;">
        <label>
          <input type="checkbox" id="editEnabled" name="enabled" checked> Включено
        </label>
      </div>
      <button type="submit" style="width: 100%; padding: 10px; background: #007bff; color: white; border: none; border-radius: 4px;">Сохранить</button>
    </form>
  </div>
</div>

<!-- Processes Management Section -->
<div style="padding: 20px; background: rgba(255,255,255,0.1); border-radius: 8px;">
  <h2>Автоматизированные процессы</h2>
  <button id="createProcessBtn" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 15px;">Создать процесс</button>

  <div id="loading" style="text-align: center; margin: 20px;">Загрузка процессов...</div>
  <table id="processes-table" style="display: none; width: 100%; border-collapse: collapse; margin-top: 10px;">
    <thead>
      <tr>
        <th style="border: 1px solid #ccc; padding: 10px;">Имя</th>
        <th style="border: 1px solid #ccc; padding: 10px;">Команда</th>
        <th style="border: 1px solid #ccc; padding: 10px;">Расписание</th>
        <th style="border: 1px solid #ccc; padding: 10px;">Включено</th>
        <th style="border: 1px solid #ccc; padding: 10px;">Количество запусков</th>
        <th style="border: 1px solid #ccc; padding: 10px;">Последний запуск</th>
        <th style="border: 1px solid #ccc; padding: 10px;">Действия</th>
      </tr>
    </thead>
    <tbody id="processes-body">
    </tbody>
  </table>
  <div id="no-processes" style="display: none; text-align: center; margin: 20px;">Процессы недоступны</div>
  <div id="error" style="display: none; color: red; margin-top: 10px;">Ошибка загрузки процессов</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Modal elements
  const editModal = document.getElementById('editModal');
  const closeEditModal = document.getElementById('closeEditModal');
  const editForm = document.getElementById('editForm');

  // Modal event listeners
  closeEditModal.onclick = () => editModal.style.display = 'none';
  window.onclick = function(event) {
    if (event.target == editModal) editModal.style.display = 'none';
  }

  // Form submission
  editForm.onsubmit = function(e) {
    e.preventDefault();
    const processId = document.getElementById('editProcessId').value;
    const formData = new FormData(editForm);
    const data = {
      name: formData.get('name'),
      command: formData.get('command'),
      schedule: formData.get('schedule'),
      enabled: document.getElementById('editEnabled').checked
    };

    const method = processId ? 'PUT' : 'POST';
    const url = processId ? `/api/v1/processes/${processId}` : '/api/v1/processes';

    fetch(url, {
      method: method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    })
    .then(res => {
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    })
    .then(result => {
      if (result.success || result.id) {
        alert(processId ? 'Процесс обновлен успешно' : 'Процесс создан успешно');
        editModal.style.display = 'none';
        loadProcesses();
      } else {
        alert('Операция не удалась');
      }
    })
    .catch(err => {
      alert('Ошибка: ' + err.message);
    });
  };

  // Create process button
  document.getElementById('createProcessBtn').onclick = () => showEditModal();

  function loadProcesses() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('processes-table').style.display = 'none';
    document.getElementById('no-processes').style.display = 'none';
    document.getElementById('error').style.display = 'none';

    fetch('/api/v1/processes')
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}: Не удалось загрузить процессы`);
        return res.json();
      })
      .then(data => {
        const tbody = document.getElementById('processes-body');
        tbody.innerHTML = '';
        if (data.length === 0) {
          document.getElementById('no-processes').style.display = 'block';
        } else {
          data.forEach(process => {
            const row = tbody.insertRow();
            row.insertCell(0).textContent = process.name || '';
            row.insertCell(1).textContent = process.command || '';
            row.insertCell(2).textContent = process.schedule || '';
            row.insertCell(3).textContent = process.enabled ? 'Да' : 'Нет';
            row.insertCell(4).textContent = process.run_count || 0;
            row.insertCell(5).textContent = process.last_run || 'Никогда';

            const actionCell = row.insertCell(6);
            const editBtn = document.createElement('button');
            editBtn.textContent = 'Редактировать';
            editBtn.style = 'padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;';
            editBtn.onclick = () => showEditModal(process);
            actionCell.appendChild(editBtn);

            const toggleBtn = document.createElement('button');
            toggleBtn.textContent = process.enabled ? 'Отключить' : 'Включить';
            toggleBtn.style = `padding: 5px 10px; background: ${process.enabled ? '#ffc107' : '#28a745'}; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;`;
            toggleBtn.onclick = () => toggleProcess(process.id, !process.enabled);
            actionCell.appendChild(toggleBtn);

            const runBtn = document.createElement('button');
            runBtn.textContent = 'Запустить сейчас';
            runBtn.style = 'padding: 5px 10px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;';
            runBtn.onclick = () => runProcess(process.id);
            actionCell.appendChild(runBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Удалить';
            deleteBtn.style = 'padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;';
            deleteBtn.onclick = () => deleteProcess(process.id);
            actionCell.appendChild(deleteBtn);
          });
          document.getElementById('processes-table').style.display = 'table';
        }
        document.getElementById('loading').style.display = 'none';
      })
      .catch(err => {
        console.error('Ошибка загрузки процессов:', err);
        document.getElementById('error').textContent = 'Ошибка загрузки процессов: ' + err.message;
        document.getElementById('error').style.display = 'block';
        document.getElementById('loading').style.display = 'none';
      });
  }

  function showEditModal(process = null) {
    document.getElementById('editProcessId').value = process ? process.id : '';
    document.getElementById('editName').value = process ? process.name || '' : '';
    document.getElementById('editCommand').value = process ? process.command || '' : '';
    document.getElementById('editSchedule').value = process ? process.schedule || '' : '';
    document.getElementById('editEnabled').checked = process ? process.enabled : true;
    document.getElementById('modalTitle').textContent = process ? 'Редактировать процесс' : 'Создать процесс';
    editModal.style.display = 'block';
  }

  function toggleProcess(processId, enabled) {
    fetch(`/api/v1/processes/${processId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ enabled: enabled })
    })
    .then(res => {
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    })
    .then(result => {
      if (result.success) {
        alert(`Процесс ${enabled ? 'включен' : 'отключен'} успешно`);
        loadProcesses();
      } else {
        alert('Переключение не удалось');
      }
    })
    .catch(err => {
      alert('Ошибка: ' + err.message);
    });
  }

  function runProcess(processId) {
    if (!confirm('Запустить этот процесс сейчас?')) return;
    // Note: This would typically trigger the process execution
    // For now, we'll just show a message
    alert('Здесь будет запущено выполнение процесса. Это требует интеграции с планировщиком бэкенда.');
  }

  function deleteProcess(processId) {
    if (!confirm('Вы уверены, что хотите удалить этот процесс?')) return;
    fetch(`/api/v1/processes/${processId}`, { method: 'DELETE' })
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
      })
      .then(result => {
        if (result.success) {
          alert('Процесс удален успешно');
          loadProcesses();
        } else {
          alert('Удаление не удалось');
        }
      })
      .catch(err => {
        alert('Ошибка: ' + err.message);
      });
  }

  // Initial load
  loadProcesses();
});
</script>
{% endblock %}