{% extends "base.html" %}

{% block content %}
<div class="stats-container" style="display: flex; gap: 20px; flex-wrap: wrap;">
   <div class="stat-card">
     <h3>–í—Å–µ–≥–æ –£–∑–ª–æ–≤</h3>
     <div id="total-nodes">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
   </div>
   <div class="stat-card">
     <h3>–í—Å–µ–≥–æ –°–æ–æ–±—â–µ–Ω–∏–π</h3>
     <div id="total-messages">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
   </div>
   <div class="stat-card">
     <h3>–ê–∫—Ç–∏–≤–Ω—ã—Ö –¢–µ–º</h3>
     <div id="active-topics">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
   </div>
   <div class="stat-card">
     <h3>–ê–∫—Ç–∏–≤–Ω—ã—Ö –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
     <div id="active-users">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
   </div>
   <div class="stat-card">
     <h3>–í—Å–µ–≥–æ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
     <div id="total-users">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
   </div>
   <div class="stat-card">
     <h3>–ê–∫—Ç–∏–≤–Ω—ã—Ö –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (24—á)</h3>
     <div id="active-users-24h">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
   </div>
   <div class="stat-card">
     <h3>–°–æ–æ–±—â–µ–Ω–∏–π –°–µ–≥–æ–¥–Ω—è</h3>
     <div id="today-messages">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
   </div>
 <div class="stat-card">
 <h3>–°—Ç–∞—Ç—É—Å –ë–æ—Ç–∞</h3>
 <div id="bot-status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
 </div>
</div>

<div class="activity-container">
   <h3>–ù–µ–¥–∞–≤–Ω—è—è –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h3>
   <div id="activity-feed" style="max-height: 400px; overflow-y: auto;">
     –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏...
   </div>
</div>

<div id="error" style="display: none; color: red; margin-top: 10px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>

<div style="margin-top: 20px;">
    <button id="refresh-btn" onclick="manualRefresh()" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
</div>

<script>
function loadStats() {
    // Show loading state
    const statElements = ['total-nodes', 'total-messages', 'active-topics', 'active-users', 'total-users', 'active-users-24h', 'today-messages', 'bot-status'];
    statElements.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
    });

    fetch('/api/v1/stats')
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É`);
        return res.json();
      })
      .then(data => {
        // Update stats with smooth transitions
        const updates = [
            { id: 'total-nodes', value: data.total_nodes || 0 },
            { id: 'total-messages', value: data.total_messages || 0 },
            { id: 'active-topics', value: data.active_topics || 0 },
            { id: 'active-users', value: data.active_users || 0 },
            { id: 'total-users', value: data.total_users || 0 },
            { id: 'active-users-24h', value: data.active_users_24h || 0 },
            { id: 'today-messages', value: data.today_messages || 0 }
        ];

        updates.forEach(({ id, value }) => {
            const el = document.getElementById(id);
            if (el) {
                el.style.transition = 'color 0.3s ease';
                el.textContent = value;
            }
        });

        const botStatusEl = document.getElementById('bot-status');
        const status = data.bot_status || 'unknown';
        botStatusEl.textContent = status;
        botStatusEl.className = `status-indicator ${status}`;

        document.getElementById('error').style.display = 'none';
      })
      .catch(err => {
        console.error('Stats fetch error:', err);
        document.getElementById('error').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + err.message;
        document.getElementById('error').style.display = 'block';

        // Reset loading states on error
        statElements.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.textContent = '–û—à–∏–±–∫–∞';
        });
      });
}

function loadActivity() {
    return fetch('/api/v1/activity')
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å`);
        return res.json();
      })
      .then(data => {
        updateActivityFeed(data);
      })
      .catch(err => {
        console.error('Activity fetch error:', err);
        document.getElementById('activity-feed').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏: ' + err.message;
      });
}

function updateActivityFeed(activity) {
   const feedEl = document.getElementById('activity-feed');
   if (!activity || activity.length === 0) {
     feedEl.innerHTML = '<p>–ù–µ—Ç –Ω–µ–¥–∞–≤–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</p>';
     return;
   }

   const html = activity.map(item => {
     const typeIcon = item.type === 'message' ? 'üí¨' : item.type === 'command' ? '‚öôÔ∏è' : item.type === 'node' ? 'üì°' : 'üìù';
     const time = new Date(item.timestamp).toLocaleString();
     return `<div class="activity-item">
       <strong>${typeIcon} ${item.type.toUpperCase()}</strong> –æ—Ç ${item.source}<br>
       <small>${time}</small><br>
       ${item.content}
     </div>`;
   }).join('');

   feedEl.innerHTML = html;
}


function manualRefresh() {
    const btn = document.getElementById('refresh-btn');
    btn.disabled = true;
    btn.textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
    loadStats();
    loadActivity().then(() => {
        btn.disabled = false;
        btn.textContent = '–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ';
    });
}

loadStats();
loadActivity();
setInterval(loadStats, 10000); // –û–±–Ω–æ–≤–ª—è—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
setInterval(loadActivity, 10000); // –û–±–Ω–æ–≤–ª—è—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
</script>
{% endblock %}