{% extends "base.html" %}

{% block content %}
<!-- Modal for node details and registration -->
<div id="nodeModal" class="modal">
  <div class="modal-content">
    <span id="closeModal" class="close">&times;</span>
    <h2 id="modalTitle" style="color: var(--text-color);">Детали узла</h2>
    <div id="nodeDetails"></div>
    <h3 style="color: var(--text-color);">Регистрация пользователя на этом узле</h3>
    <form id="registerForm">
      <input type="hidden" id="modalNodeId" name="node_id">
      <div style="margin-bottom: 15px;">
        <label for="regUsername" style="color: var(--text-color);">Имя пользователя (3-20 символов):</label>
        <input type="text" id="regUsername" name="username" required minlength="3" maxlength="20" style="width: 100%; padding: 8px; box-sizing: border-box;">
      </div>
      <div style="margin-bottom: 15px;">
        <label for="regPassword" style="color: var(--text-color);">Пароль (6+ символов):</label>
        <input type="password" id="regPassword" name="password" required minlength="6" style="width: 100%; padding: 8px; box-sizing: border-box;">
      </div>
      <div style="margin-bottom: 15px;">
        <label for="regNickname" style="color: var(--text-color);">Псевдоним (необязательно):</label>
        <input type="text" id="regNickname" name="nickname" style="width: 100%; padding: 8px; box-sizing: border-box;">
      </div>
      <div style="margin-bottom: 15px;">
        <label for="regEmail" style="color: var(--text-color);">Email (необязательно):</label>
        <input type="email" id="regEmail" name="email" style="width: 100%; padding: 8px; box-sizing: border-box;">
      </div>
      <button type="submit" style="width: 100%; padding: 10px; background: #28a745; color: white; border: none; border-radius: 4px;">Регистрация</button>
    </form>
  </div>
</div>

<div class="stats-container" style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
<div class="stat-card">
  <h3 style="color: var(--text-color);">Всего узлов</h3>
  <div id="total-nodes">--</div>
</div>
<div class="stat-card">
  <h3 style="color: var(--text-color);">Онлайн сейчас</h3>
  <div id="online-nodes">--</div>
</div>
<div class="stat-card">
  <h3 style="color: var(--text-color);">Макс. онлайн за 24ч</h3>
  <div id="max-online-24h">N/A</div>
</div>
</div>

<div style="margin-bottom: 20px;">
<button id="refreshBtn" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Обновить</button>
</div>
<div id="loading" style="text-align: center; margin: 20px;">Загрузка узлов...</div>
<div id="nodes-cards" style="display: none;"></div>
<div id="no-nodes" style="display: none; text-align: center; margin: 20px;">Узлы недоступны</div>
<div id="error" style="display: none; color: red; margin-top: 10px;">Ошибка загрузки узлов</div>

<script>
function formatTimestamp(timestamp) {
  if (!timestamp || timestamp === 'N/A') return 'N/A';
  let date;
  if (typeof timestamp === 'string') {
    date = new Date(timestamp);
  } else if (typeof timestamp === 'number') {
    // Assume Unix timestamp: if > 1e10, milliseconds, else seconds
    date = new Date(timestamp > 1e10 ? timestamp : timestamp * 1000);
  } else {
    return 'N/A';
  }
  if (isNaN(date.getTime())) return 'N/A';
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const year = date.getFullYear();
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  const seconds = String(date.getSeconds()).padStart(2, '0');
  return `${day}.${month}.${year} ${hours}:${minutes}:${seconds}`;
}

document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('nodeModal');
  const closeModal = document.getElementById('closeModal');
  const registerForm = document.getElementById('registerForm');

  closeModal.onclick = function() {
    modal.style.display = 'none';
  }

  window.onclick = function(event) {
    if (event.target == modal) {
      modal.style.display = 'none';
    }
  }

  registerForm.onsubmit = function(e) {
    e.preventDefault();
    const formData = new FormData(registerForm);
    const data = {
      node_id: formData.get('node_id'),
      username: formData.get('username'),
      password: formData.get('password'),
      nickname: formData.get('nickname') || null,
      email: formData.get('email') || null
    };

    fetch('/api/v1/register_node', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(result => {
      if (result.success) {
        alert('Регистрация успешна! Пожалуйста, войдите.');
        window.location.href = '/login';
      } else {
        alert('Регистрация не удалась: ' + (result.error || 'Неизвестная ошибка'));
      }
    })
    .catch(err => {
      alert('Ошибка: ' + err.message);
    });
  };

  // Manual refresh button
  document.getElementById('refreshBtn').onclick = loadNodes;

  function loadNodes() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('nodes-cards').style.display = 'none';
    document.getElementById('no-nodes').style.display = 'none';
    document.getElementById('error').style.display = 'none';

    fetch('/api/v1/nodes')
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}: Не удалось загрузить узлы`);
        return res.json();
      })
      .then(data => {
        // Update stats
        const totalNodes = data.length;
        const onlineNodes = data.filter(node => node.is_online).length;
        document.getElementById('total-nodes').textContent = totalNodes;
        document.getElementById('online-nodes').textContent = onlineNodes;
        document.getElementById('max-online-24h').textContent = 'N/A';

        const container = document.getElementById('nodes-cards');
        container.innerHTML = '';
        if (data.length === 0) {
          document.getElementById('no-nodes').style.display = 'block';
        } else {
          data.forEach(node => {
            const card = document.createElement('div');
            card.className = 'node-card';
            card.onclick = () => showNodeModal(node);

            const statusClass = node.is_online ? 'status-online' : 'status-offline';
            const statusText = node.is_online ? 'Онлайн' : 'Офлайн';
            const userInfo = node.username ? `${node.username}${node.nickname ? ` (${node.nickname})` : ''}` : 'N/A';

            let shortName = 'N/A';
            if (node.id && node.id.startsWith('!')) {
              shortName = node.id.substring(1, 5);
            }

            card.innerHTML = `
              <div class="node-card-header">
                <div class="node-name">${node.name || node.id}</div>
                <div class="node-status ${statusClass}">${statusText}</div>
              </div>
              <div class="node-details">
                <div class="node-detail">
                  <span class="node-detail-label">ID:</span>
                  <span class="node-detail-value">${node.id}</span>
                </div>
                <div class="node-detail">
                  <span class="node-detail-label">ShortName:</span>
                  <span class="node-detail-value">${shortName}</span>
                </div>
                <div class="node-detail">
                  <span class="node-detail-label">Пользователь:</span>
                  <span class="node-detail-value">${userInfo}</span>
                </div>
                <div class="node-detail">
                  <span class="node-detail-label">Последний раз:</span>
                  <span class="node-detail-value">${formatTimestamp(node.last_seen)}</span>
                </div>
                <div class="node-detail">
                  <span class="node-detail-label">Батарея:</span>
                  <span class="node-detail-value">${node.battery_level ? node.battery_level + '%' : 'N/A'}</span>
                </div>
                <div class="node-detail">
                  <span class="node-detail-label">Позиция:</span>
                  <span class="node-detail-value">${node.lat && node.lng ? `${node.lat.toFixed(4)}, ${node.lng.toFixed(4)}` : 'N/A'}</span>
                </div>
                <div class="node-detail">
                  <span class="node-detail-label">SNR/RSSI:</span>
                  <span class="node-detail-value">${node.snr || 'N/A'} / ${node.rssi || 'N/A'}</span>
                </div>
              </div>
            `;

            container.appendChild(card);
          });
          document.getElementById('nodes-cards').style.display = 'block';
        }
        document.getElementById('loading').style.display = 'none';
      })
      .catch(err => {
        console.error('Ошибка загрузки узлов:', err);
        document.getElementById('error').textContent = 'Ошибка загрузки узлов: ' + err.message;
        document.getElementById('error').style.display = 'block';
        document.getElementById('loading').style.display = 'none';
      });
  }

  function showNodeModal(node) {
    document.getElementById('modalTitle').textContent = `Узел: ${node.name || node.id}`;
    const userInfo = node.username ? `
      <h4 style="color: var(--text-color);">Информация о пользователе</h4>
      <p style="color: var(--text-color);"><strong>Имя пользователя:</strong> ${node.username}</p>
      <p style="color: var(--text-color);"><strong>Псевдоним:</strong> ${node.nickname || 'N/A'}</p>
      <p style="color: var(--text-color);"><strong>Email:</strong> ${node.email || 'N/A'}</p>
      <p style="color: var(--text-color);"><strong>Роль:</strong> ${node.role || 'N/A'}</p>
    ` : '<p style="color: var(--text-color);"><em>Нет связанного пользователя</em></p>';

    const statusIndicator = node.is_online ? '<span class="status-indicator online">● Онлайн</span>' : '<span class="status-indicator offline">● Офлайн</span>';
    const telemetrySection = `
      <h4 style="color: var(--text-color);">Телеметрия</h4>
      <p style="color: var(--text-color);"><strong>Статус:</strong> ${statusIndicator}</p>
      <p style="color: var(--text-color);"><strong>SNR:</strong> ${node.snr || 'N/A'} dB</p>
      <p style="color: var(--text-color);"><strong>RSSI:</strong> ${node.rssi || 'N/A'} dBm</p>
      <p style="color: var(--text-color);"><strong>Количество хопов:</strong> ${node.hop_count || 'N/A'}</p>
      <p style="color: var(--text-color);"><strong>PKI статус:</strong> ${node.pki_status || 'N/A'}</p>
      <p style="color: var(--text-color);"><strong>Модель устройства:</strong> ${node.hardware_model || 'N/A'}</p>
      <p style="color: var(--text-color);"><strong>Версия прошивки:</strong> ${node.firmware_version || 'N/A'}</p>
      <p style="color: var(--text-color);"><strong>Роль:</strong> ${node.role || 'N/A'}</p>
      <p style="color: var(--text-color);"><strong>Скорость:</strong> ${node.ground_speed ? node.ground_speed + ' м/с' : 'N/A'}</p>
      <p style="color: var(--text-color);"><strong>Точность битов:</strong> ${node.precision_bits || 'N/A'}</p>
      <p style="color: var(--text-color);"><strong>Последняя телеметрия:</strong> ${formatTimestamp(node.last_telemetry)}</p>
    `;

    document.getElementById('nodeDetails').innerHTML = `
      <h4 style="color: var(--text-color);">Информация об узле</h4>
      <p style="color: var(--text-color);"><strong>ID:</strong> ${node.id}</p>
      <p style="color: var(--text-color);"><strong>Имя:</strong> ${node.name || 'N/A'}</p>
      <p style="color: var(--text-color);"><strong>Широта:</strong> ${node.lat || 'N/A'}</p>
      <p style="color: var(--text-color);"><strong>Долгота:</strong> ${node.lng || 'N/A'}</p>
      <p style="color: var(--text-color);"><strong>Высота:</strong> ${node.altitude || 'N/A'}</p>
      <p style="color: var(--text-color);"><strong>Батарея:</strong> ${node.battery_level ? node.battery_level + '%' : 'N/A'}</p>
      <p style="color: var(--text-color);"><strong>Последний раз:</strong> ${formatTimestamp(node.last_seen)}</p>
      ${telemetrySection}
      ${userInfo}
    `;
    document.getElementById('modalNodeId').value = node.id;
    document.getElementById('regUsername').value = '';
    document.getElementById('regPassword').value = '';
    document.getElementById('regNickname').value = '';
    document.getElementById('regEmail').value = '';
    modal.style.display = 'block';
  }

  loadNodes();
});

// Auto-refresh
setInterval(loadNodes, 30000);
</script>
{% endblock %}