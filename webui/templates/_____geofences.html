{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Геозоны</h2>
    <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#geofenceModal" onclick="openAddModal()">Добавить Новую Геозону</button>

    <table class="table table-striped" id="geofencesTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Название</th>
                <th>Широта</th>
                <th>Долгота</th>
                <th>Радиус</th>
                <th>Активна</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody id="geofencesTbody">
            {% if geofences %}
                {% for geofence in geofences %}
                <tr data-id="{{ geofence.id }}">
                    <td>{{ geofence.id }}</td>
                    <td>{{ geofence.name }}</td>
                    <td>{{ geofence.latitude }}</td>
                    <td>{{ geofence.longitude }}</td>
                    <td>{{ geofence.radius }}</td>
                    <td>
                        <input type="checkbox" class="form-check-input active-toggle" {{ 'checked' if geofence.active else '' }} data-id="{{ geofence.id }}">
                    </td>
                    <td>
                        <button class="btn btn-sm btn-warning edit-btn" data-id="{{ geofence.id }}">Редактировать</button>
                        <button class="btn btn-sm btn-danger delete-btn" data-id="{{ geofence.id }}">Удалить</button>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="7" class="text-center">Геозоны не найдены.</td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- Modal for Add/Edit Geofence -->
<div class="modal fade" id="geofenceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Добавить Геозону</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="geofenceForm">
                    <input type="hidden" id="geofenceId" value="">
                    <div class="mb-3">
                        <label for="name" class="form-label">Название</label>
                        <input type="text" class="form-control" id="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="latitude" class="form-label">Широта (-90 до 90)</label>
                        <input type="number" step="any" class="form-control" id="latitude" required>
                    </div>
                    <div class="mb-3">
                        <label for="longitude" class="form-label">Долгота (-180 до 180)</label>
                        <input type="number" step="any" class="form-control" id="longitude" required>
                    </div>
                    <div class="mb-3">
                        <label for="radius" class="form-label">Радиус (>0)</label>
                        <input type="number" step="any" class="form-control" id="radius" value="100" required>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="active" checked>
                        <label class="form-check-label" for="active">Активна</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary" onclick="saveGeofence()">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<script>
let editingId = null;
window.geoData = {{ geofences | tojson | safe }};
let geoData = window.geoData;

function renderTable() {
    const tbody = document.getElementById('geofencesTbody');
    tbody.innerHTML = '';
    if (geoData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">Геозоны не найдены.</td></tr>';
        return;
    }
    geoData.forEach(g => {
        const row = document.createElement('tr');
        row.dataset.id = g.id;
        row.innerHTML = `
            <td>${g.id}</td>
            <td>${g.name}</td>
            <td>${g.latitude}</td>
            <td>${g.longitude}</td>
            <td>${g.radius}</td>
            <td><input type="checkbox" class="form-check-input active-toggle" ${g.active ? 'checked' : ''} data-id="${g.id}"></td>
            <td>
                <button class="btn btn-sm btn-warning edit-btn" data-id="${g.id}">Редактировать</button>
                <button class="btn btn-sm btn-danger delete-btn" data-id="${g.id}">Удалить</button>
            </td>
        `;
        tbody.appendChild(row);
    });
    // Re-attach event listeners
    document.querySelectorAll('.active-toggle').forEach(toggle => {
        toggle.removeEventListener('change', handleActiveToggle);
        toggle.addEventListener('change', handleActiveToggle);
    });
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.removeEventListener('click', handleEditClick);
        btn.addEventListener('click', handleEditClick);
    });
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.removeEventListener('click', handleDeleteClick);
        btn.addEventListener('click', handleDeleteClick);
    });
}

function handleEditClick(e) {
    openEditModal(parseInt(e.target.dataset.id));
}

function handleDeleteClick(e) {
    deleteGeofence(parseInt(e.target.dataset.id));
}

function openAddModal() {
    document.getElementById('modalTitle').textContent = 'Добавить Геозону';
    document.getElementById('geofenceForm').reset();
    document.getElementById('geofenceId').value = '';
    document.getElementById('active').checked = true;
    editingId = null;
}

function openEditModal(id) {
    const geofence = geoData.find(g => g.id == id);
    if (!geofence) return;
    document.getElementById('modalTitle').textContent = 'Редактировать Геозону';
    document.getElementById('geofenceId').value = id;
    document.getElementById('name').value = geofence.name;
    document.getElementById('latitude').value = geofence.latitude;
    document.getElementById('longitude').value = geofence.longitude;
    document.getElementById('radius').value = geofence.radius;
    document.getElementById('active').checked = geofence.active;
    editingId = id;
    new bootstrap.Modal(document.getElementById('geofenceModal')).show();
}

function saveGeofence() {
    const id = document.getElementById('geofenceId').value;
    const data = {
        name: document.getElementById('name').value,
        latitude: parseFloat(document.getElementById('latitude').value),
        longitude: parseFloat(document.getElementById('longitude').value),
        radius: parseFloat(document.getElementById('radius').value),
        active: document.getElementById('active').checked ? 1 : 0
    };
    if (data.latitude < -90 || data.latitude > 90 || data.longitude < -180 || data.longitude > 180 || data.radius <= 0) {
        alert('Неверные координаты или радиус');
        return;
    }
    const url = id ? `/api/v1/geofences/${id}` : '/api/v1/geofences';
    const method = id ? 'PUT' : 'POST';
    fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
    })
    .then(result => {
        if (id) {
            const idx = geoData.findIndex(g => g.id == id);
            geoData[idx] = { ...geoData[idx], ...data };
        } else {
            data.id = result.id;
            geoData.push(data);
        }
        renderTable();
        bootstrap.Modal.getInstance(document.getElementById('geofenceModal')).hide();
        alert('Геозона успешно сохранена');
    })
    .catch(err => {
        console.error(err);
        alert('Ошибка сохранения геозоны: ' + err.message);
    });
}

function deleteGeofence(id) {
    if (!confirm('Вы уверены?')) return;
    fetch(`/api/v1/geofences/${id}`, { method: 'DELETE' })
    .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
    })
    .then(() => {
        geoData = geoData.filter(g => g.id != id);
        renderTable();
        alert('Геозона удалена');
    })
    .catch(err => {
        console.error(err);
        alert('Ошибка удаления геозоны: ' + err.message);
    });
}

function handleActiveToggle(e) {
    const id = e.target.dataset.id;
    const active = e.target.checked ? 1 : 0;
    fetch(`/api/v1/geofences/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ active })
    })
    .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const idx = geofences.findIndex(g => g.id == id);
        geofences[idx].active = active;
    })
    .catch(err => {
        console.error(err);
        e.target.checked = !active; // Revert
        alert('Ошибка обновления статуса активности');
    });
}

// Initial render
document.addEventListener('DOMContentLoaded', renderTable);
</script>
{% endblock %}