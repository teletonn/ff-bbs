# Станция Светлячок BBS LLM WEB-UI

Расширение возможностей сети Meshtastic.

Это многофункциональный бот предназначен для расширения ваших возможностей в сети Meshtastic с помощью разнообразных инструментов и ИИ интеграции, обеспечивая связь и полезность через текстовые сообщения.

Пакет находится в стадии разработки, по этому не все пока работает как планировалось, но основной функционал через WEB UI и в чате с ботом уже работает.

Проект начал свое развитие из проекта meshing-around, но сордержит множество различных улучшений и удобный WEB UI для управления ботом и визуализации сети.

Улучшеный механизм отложенной доставки сообщений.

Визуализации маршрутов, гео-зонирование, триггеры, оповещения, статистика.

Реализован механизм определения онлайн и офлайн узлов и отложенной отправки сообщений.

![Пример использования](etc/pong-bot.jpg "Пример использования")

## Ключевые особенности
![CodeQlBadge](https://github.com/SpudGunMan/meshing-around/actions/workflows/dynamic/github-code-scanning/codeql/badge.svg)

### Интеллектуальный ответчик по ключевым словам
- **Автоматические ответы**: Бот обнаруживает ключевые слова, такие как "ping", и отвечает "pong" в личных сообщениях (DM) или групповых каналах.
- **Настраиваемые триггеры**: Мониторинг групповых каналов на предмет определенных ключевых слов и установка пользовательских ответов.
- **Экстренное реагирование**: Мониторинг каналов на предмет ключевых слов, указывающих на чрезвычайные ситуации, и оповещение более широкой аудитории.
- **Приветствие новых узлов**: Приветствует новые узлы в сети «Светлячок» сообщением.

### Сетевые инструменты
- **Создание и тестирование локальной сети**: `ping` позволяет тестировать доставку сообщений с более реалистичными пакетами по сравнению с телеметрией.
- **Тестирование оборудования узла**: `test` отправляет данные возрастающего размера в буфер радио для проверки общей длины сообщения.
- **Мониторинг сети**: Оповещение о "шумных" узлах, местоположении узлов и оптимальном размещении ретрансляционных узлов.

### Поддержка нескольких радио/узлов
- **Одновременный мониторинг**: Мониторинг до девяти сетей одновременно.
- **Гибкая передача сообщений**: Отправка почты и сообщений между сетями.

### Расширенные возможности обмена сообщениями
- **Почтовые сообщения**: Оставляйте сообщения для других устройств, которые отправляются как личные сообщения, когда устройство появляется в сети.
- **Планировщик**: Планируйте сообщения, такие как обновления погоды или напоминания о еженедельных VHF-сетях.
- **Хранение и пересылка**: Повторный просмотр сообщений с помощью команды `messages` и локальное журналирование сообщений на диск.
- **Отправка почты**: Отправляйте почту на узлы с помощью `bbspost @номерУзла #сообщение` или `bbspost @короткоеИмяУзла #сообщение`.
- **Связывание BBS**: Объединяйте несколько ботов для расширения охвата BBS.
- **E-Mail/SMS**: Отправляйте сообщения из сети «Светлячок» на E-Mail или SMS (через Email) для расширения видимости.
- **Приветствие новых узлов**: Отправка приветственного сообщения любому новому узлу, появившемуся в текстовом сообщении.

### Интерактивный ИИ и поиск данных
- **Данные о местоположении NOAA/USGS**: Получайте локализованные погодные данные (оповещения), информацию о землетрясениях, уровне рек и приливах. Open-Meteo используется для погоды только за пределами покрытия NOAA.
- **Интеграция с Wiki**: Поиск данных с использованием результатов из Википедии.
- **Ollama LLM AI**: Взаимодействуйте с [Ollama](https://github.com/ollama/ollama/tree/main/docs) LLM AI для сложных запросов и ответов.
- **Информация о пролетах спутников**: Получайте информацию о пролетах спутников для вашего местоположения.
- **Геоизмерения**: `HowFar` от точки до точки с использованием собранных GPS-пакетов на боте для построения курса или пространства. Поиск центра точек для пеленгации "Охота на лис".

### Оповещения о приближении
- **Оповещения на основе местоположения**: Получайте уведомления, когда участники возвращаются в настроенную точку (широта/долгота), что идеально подходит для удаленных мест, таких как кемпинги.
- **Оповещения о большой высоте**: Получайте уведомления, когда в сети «Светлячок» появляются узлы с большой высотой.

### Контрольный список / Регистрация прибытия и убытия
- **Отслеживание активов**: Ведение списка регистрации прибытия и убытия узлов/активов. Полезно для учета людей, активов. Радиосеть, FEMA, туристические маршруты.

### Регистрация пользователей и управление доступом
- **Регистрация через Telegram**: Пользователи могут зарегистрироваться в системе с помощью команды `/reg !nodeid`, связав свой Telegram аккаунт с Meshtastic узлом. После успешной регистрации пользователь получает доступ к расширенным функциям бота.
- **Веб-интерфейс управления пользователями**: Администраторы могут управлять пользователями через веб-интерфейс (`/users`), включая создание, редактирование, активацию/деактивацию учетных записей, просмотр списка пользователей и управление их группами. Интерфейс предоставляет полную информацию о пользователях, включая Telegram данные, Mesh Node ID и статус активности.
- **Гибкая авторизация**: Система поддерживает как предварительно настроенный список авторизованных пользователей (`telegram_authorized_users`), так и динамическую регистрацию новых пользователей. Параметр `telegram_authorized_users` теперь является опциональным/резервным - если он пуст, система полагается на зарегистрированных пользователей.
- **Управление группами**: Возможность создания групп пользователей и назначения пользователей в группы для более гибкого управления доступом и разрешениями. Группы могут быть созданы, отредактированы и удалены через веб-интерфейс.

### Развлечения и игры
- **Встроенные игры**: Наслаждайтесь такими играми, как DopeWars, Lemonade Stand, BlackJack и VideoPoker.
- **FCC ARRL QuizBot**: Викторина с вопросами из экзаменационного пула.
- **Геймплей на основе команд**: Введите `games` для отображения справки и начала игры.

### Мониторинг радиочастот
- **Оповещения об активности с высоким SNR**: Мониторинг радиочастоты и получение оповещений при обнаружении высокой активности с высоким SNR.
- **Интеграция с Hamlib**: Используйте Hamlib (rigctld) для наблюдения за S-метром на подключенном радио.

### Оповещения EAS
- **Оповещения FEMA iPAWS/EAS через API**: Используйте узел с доступом в Интернет для отправки экстренных оповещений от FEMA.
- **Оповещения NOAA EAS через API**: Используйте узел с доступом в Интернет для отправки экстренных оповещений от NOAA.
- **Оповещения о вулканах USGS через API**: Используйте узел с доступом в Интернет для отправки экстренных оповещений от USGS.
- **Оповещения EAS по воздуху**: Использование внешних инструментов для передачи офлайн-оповещений EAS через сеть «Светлячок».
- **Оповещения NINA для Германии**: Экстренные оповещения из ленты xrepository.de.

### Оповещения монитора файлов
- **Монитор файлов**: Мониторинг текстового файла на предмет изменений и трансляция содержимого сообщения в канал сети.
- **Файл новостей**: По запросу `news` возвращается содержимое файла.

### Отчетность по данным
- **Генератор HTML**: Визуализируйте трафик и потоки данных бота с помощью встроенного генератора HTML для [отчетности по данным](logs/README.md).

### Надежная обработка сообщений
- **Разбивка сообщений на части**: Автоматическая разбивка сообщений длиннее 160 символов для обеспечения более высокой успешности доставки через несколько хопов.

## Начало работы
Этот проект разработан на Linux (в частности, на Raspberry Pi), но должен работать на любой платформе, где поддерживаются модули [Meshtastic protobuf API](https://meshtastic.org/docs/software/python/cli/) и с любым совместимым оборудованием [Meshtastic](https://meshtastic.org/docs/getting-started/). Для устройств с низкой мощностью, таких как pico, см. проекты для встраиваемых систем, [buildroot](https://github.com/buildroot-meshtastic/buildroot-meshtastic), а также [femtofox](https://github.com/noon92/femtofox). 🥔 Пожалуйста, используйте ответственно и соблюдайте местные правила для такого оборудования. Этот проект захватывает пакеты, регистрирует их и обрабатывает радиосвязь, которая может включать личную информацию, такую как GPS-координаты.

### Быстрая настройка
#### Клонирование репозитория
Если у вас нет git, вам нужно его установить: `sudo apt-get install git`
```sh
git clone https://github.com/spudgunman/meshing-around
```
- **Автоматическая установка**: `install.sh` автоматизирует установку опциональной виртуальной среды и зависимостей.
- **Скрипт запуска**: `launch.sh` используется только при установке в виртуальной среде для запуска бота и генератора отчетов.

## Полный список команд для бота

### Сеть
| Команда | Описание | ✅ Работает Off-Grid |
|---------|-------------|-
| `ping`, `ack` | Возвращает данные о сигнале. Пример: `ping 15 #DrivingI5` (активирует авто-пинг каждые 20 секунд 15 раз только через DM) | ✅ |
| `cmd` | Возвращает список команд (справочное сообщение) | ✅ |
| `history` | Возвращает последние команды, выполненные пользователем(ями) | ✅ |
| `lheard` | Возвращает последние 5 услышанных узлов с SNR. Также можно использовать `sitrep` | ✅ |
| `motd` | Отображает сообщение дня или устанавливает его. Пример: `motd $Новое сообщение дня` | ✅ |
| `sysinfo` | Возвращает телеметрическую информацию узла бота | ✅ |
| `test` | Используется для проверки пределов передачи данных `test 4` отправляет данные до предела maxBuffer (по умолчанию 220) только через DM | ✅ |
| `whereami` | Возвращает адрес местоположения отправителя, если он известен |
| `whoami` | Возвращает информацию об узле, который запрашивает, также возвращается при обмене позициями 📍 | ✅ |
| `whois` | Возвращает известную информацию об узле, больше данных с узлом bbsadmin | ✅ |
| `echo` | Возвращает строку обратно, по умолчанию отключено | ✅ |

### Распространение радиоволн и прогноз погоды
| Команда | Описание | |
|---------|-------------|-------------------
| `ea` и `ealert` | Возвращает оповещения FEMA iPAWS/EAS в США или заголовки DE или подробную информацию для США | |
| `earthquake` | Возвращает крупнейшие и количество событий USGS для данного местоположения | |
| `hfcond` | Возвращает таблицу условий на КВ-диапазонах | |
| `rlist` | Возвращает таблицу ближайших ретрансляторов из RepeaterBook | |
| `riverflow` | Возвращает информацию от NOAA об уровне рек. Пример: `riverflow modules/settings.py`| |
| `solar` | Дает представление о потоке рентгеновского излучения | |
| `sun` и `moon` | Возвращает информацию о восходе и заходе по местному времени | ✅ |
| `tide` | Возвращает местные приливы (источник данных NOAA) | |
| `valert` | Возвращает данные о вулканах от USGS | |
| `wx` | Возвращает местный прогноз погоды, NOAA или Open Meteo (который также имеет `wxc` для метрических и имперских единиц) | |
| `wxa` и `wxalert` | Возвращает оповещения NOAA. Краткий заголовок или подробная информация | |
| `mwx` | Возвращает данные прогноза NOAA для прибрежных морских вод | |

### Доска объявлений и почта
| Команда | Описание | |
|---------|-------------|-
| `bbshelp` | Возвращает следующее справочное сообщение | ✅ |
| `bbslist` | Перечисляет сообщения по ID и теме | ✅ |
| `bbsread` | Читает сообщение. Пример: `bbsread #1` | ✅ |
| `bbspost` | Публикует сообщение на общедоступной доске или отправляет DM (почту). Примеры: `bbspost $тема #сообщение`, `bbspost @номерУзла #сообщение`, `bbspost @короткоеИмяУзла #сообщение` | ✅ |
| `bbsdelete` | Удаляет сообщение. Пример: `bbsdelete #4` | ✅ |
| `bbsinfo` | Предоставляет статистику по доставке BBS и сообщениям (для сисопа) | ✅ |
| `bbslink` | Связывает сообщения доски объявлений между системами BBS | ✅ |
| `email:`  | Отправляет email на адрес, указанный для узла, или `email: bob@test.net # привет из сети` | |
| `sms:`    | Отправляет sms-email на несколько адресов, указанных для узла | |
| `setemail`| Устанавливает email для удобной связи | |
| `setsms` | Добавляет SMS-Email для быстрой связи | |
| `clearsms` | Удаляет все SMS-Email, указанные для узла | |

### Поиск данных
| Команда | Описание | |
|---------|-------------|-
| `askai` и `ask:` | Запросить ответ у Ollama LLM AI. Пример: `askai при какой температуре готовить курицу` | ✅ |
| `messages` | Воспроизводит последние услышанные сообщения, как Store and Forward | ✅ |
| `readnews` | Возвращает содержимое файла (по умолчанию news.txt) через разбивку на части по воздуху | ✅ |
| `satpass` | Возвращает информацию о пролетах спутников из API для определенного NORAD ID в конфиге или Пример: `satpass 25544,33591`| |
| `wiki:` | Ищет в Википедии и возвращает первые несколько предложений первого результата, если есть совпадение. Пример: `wiki: радио lora` |
| `howfar` | Возвращает расстояние, которое вы проехали с момента последнего вызова `HowFar`. `howfar reset` для сброса | ✅ |
| `howtall` | Возвращает высоту чего-либо по длине тени, используя угол солнца | ✅ |

### Контрольный список
| Команда | Описание | |
|---------|-------------|-
| `checkin` | Регистрирует узел в базе данных контрольного списка, можно добавить примечание, например `checkin ICO` или `checkin radio4` | ✅ |
| `checkout` | Снимает узел с регистрации в базе данных контрольного списка, снимает все с узла | ✅ |
| `checklist` | Отображает базу данных контрольного списка с примечаниями | ✅ |
| `/reg !nodeid` | Регистрация пользователя с Meshtastic узлом (например, `/reg !4a300a5c`) | ✅ |

### Игры (только через DM)
| Команда | Описание | |
|---------|-------------|-
| `blackjack` | Игра в Блэкджек (Казино 21) | ✅ |
| `dopewars` | Классическая игра в торговлю наркотиками | ✅ |
| `golfsim` | 9-луночный симулятор гольфа | ✅ |
| `hamtest` | Викторина FCC/ARRL `hamtest general` или `hamtest extra` и `score` | ✅ |
| `hangman` | Классическая игра в угадывание слов | ✅ |
| `joke` | Рассказывает анекдот | |
| `lemonstand` | Классическая финансовая игра "Лимонадный киоск" | ✅ |
| `mastermind` | Классическая игра на взлом кода | ✅ |
| `videopoker` | Базовый 5-карточный видеопокер | ✅ |

## Другие варианты установки

### Установка через Docker - удобно для Windows
Дополнительную информацию см. в [docker.md](script/docker/README.md)

### Ручная установка
Установите необходимые зависимости с помощью pip:
```sh
pip install -r requirements.txt
```

Скопируйте шаблон конфигурации в `config.ini` и отредактируйте его в соответствии с вашими потребностями:
```sh
cp config.template config.ini
```

### Руководство по конфигурации
Ниже приведена документация для файла `config.ini`.

Если вы еще этого не сделали или хотите выполнить "сброс к заводским настройкам", скопируйте [config.template](config.template) в `config.ini` и установите соответствующий интерфейс для вашего метода (serial/ble/tcp). Хотя BLE и TCP будут работать, они не так надежны, как последовательные соединения. Существует сторожевой таймер для переподключения TCP, если это возможно. Чтобы получить MAC-адрес BLE, используйте:
```sh
meshtastic --ble-scan
```

**Примечание**: Код был протестирован с одним устройством BLE и написан для поддержки только одного порта BLE.

```ini
# config.ini
# type может быть serial, tcp или ble.
# port - последовательный порт для использования; закомментированный попытается автоопределиться
# hostname - IP-адрес устройства для подключения по TCP
# mac - MAC-адрес устройства для подключения по BLE

[interface]
type = serial
# port = '/dev/ttyUSB0'
# hostname = 192.168.0.1
# mac = 00:11:22:33:44:55

# Дополнительный интерфейс для поддержки двух радио. См. config.template для получения дополнительной информации.
[interface2]
enabled = False
```

## Управление базой данных

### Шаблон базы данных (dashboard_template.db)

Проект использует SQLite базу данных для хранения данных веб-интерфейса. Файл `webui/dashboard_template.db` содержит шаблон базы данных с правильной схемой, которая используется при обновлениях системы.

#### Что содержит dashboard_template.db

Шаблон базы данных включает следующие таблицы с полной схемой:

- **nodes** - информация об узлах сети (местоположение, статус, телеметрия)
- **messages** - сообщения между узлами с информацией о доставке
- **users** - пользователи веб-интерфейса и их настройки
- **forum_posts** - сообщения форума
- **geofences** - гео-зоны для триггеров
- **triggers** - автоматизированные действия на основе событий
- **commands_queue** - очередь команд для выполнения
- **settings** - системные настройки
- **user_groups** - группы пользователей для управления доступом
- **user_group_assignments** - связи пользователей с группами
- **alerts** - системные оповещения
- **alert_configs** - конфигурации оповещений
- **processes** - автоматизированные процессы
- **zones** - географические зоны
- **telemetry** - исторические данные телеметрии
- **route_traces** - трассировка маршрутов сообщений

#### Процесс обновления базы данных

При запуске скрипта `update.sh` система автоматически:

1. **Создает резервную копию** текущей базы данных `dashboard.db` с временной меткой
2. **Копирует шаблон** `dashboard_template.db` поверх существующей базы данных
3. **Сохраняет данные** - схема обновляется, но существующие данные остаются

Это обеспечивает:
- **Совместимость** - база данных всегда имеет актуальную схему
- **Безопасность** - резервные копии предотвращают потерю данных
- **Автоматизацию** - процесс обновления не требует ручного вмешательства

#### Важные замечания

- **Резервные копии** сохраняются в формате `dashboard.db.backup_YYYYMMDD_HHMMSS`
- **WAL режим** включен для одновременного чтения и записи
- **Иностранные ключи** активированы для поддержания целостности данных
- **Индексы** оптимизированы для быстрого поиска и фильтрации

Если вам нужно восстановить данные из резервной копии или выполнить ручное управление базой данных, обратитесь к файлам `webui/database.py` и `webui/db_handler.py` для получения дополнительной информации о структуре и функциях.

### Общие настройки
Следующие настройки определяют, как отвечает бот. По умолчанию бот не будет спамить в основной канал. Установка `respond_by_dm_only` в `True` заставит все сообщения отправляться через DM, что может быть нежелательно. Установка в [`False`] позволит отвечать в канале для всеобщего обозрения. Если у вас нет основного канала, вы можете установить это значение в `-1` или любой неиспользуемый индекс канала. Вы также можете заставить бота игнорировать основной канал для любых команд, но при этом наблюдать за каналом.

```ini
[general]
respond_by_dm_only = True
defaultChannel = 0
ignoreDefaultChannel = False # ignoreDefaultChannel, бот будет игнорировать основной канал, установленный выше
ignoreChannels = # ignoreChannels - это список каналов для игнорирования через запятую, например 4,5
cmdBang = False # требовать, чтобы ! был первым символом в команде
explicitCmd = True # требовать явную команду, сообщение будет обработано, только если оно начинается со слова-команды; отключите, чтобы получить больше активности
```

### Настройки местоположения
Прогноз погоды по умолчанию использует NOAA, для местоположений за пределами США вы можете установить `UseMeteoWxAPI` в `True`, чтобы использовать глобальный погодный API. `lat` и `lon` являются значениями по умолчанию, когда узел не имеет данных о местоположении, а также по умолчанию для всех запросов NOAA, поиска ретрансляторов. Это также центр радиуса для Sentry.

```ini
[location]
enabled = True
lat = 48.50
lon = -123.0
UseMeteoWxAPI = True

coastalEnabled = False # Данные NOAA Coastal Включить прогнозы прибрежных вод и приливов NOAA
# Найдите правильный каталог прибрежной погоды на https://tgftp.nws.noaa.gov/data/forecasts/marine/coastal/
# эта карта может помочь https://www.weather.gov/marine выберите местоположение, а затем посмотрите на 'Forecast-by-Zone Map'
myCoastalZone = https://tgftp.nws.noaa.gov/data/forecasts/marine/coastal/pz/pzz135.txt # myCoastalZone - это .txt файл с данными прогноза
coastalForecastDays = 3 # количество возвращаемых точек данных, по умолчанию 3
```

### Настройки модулей
Модули можно включать или отключать по мере необходимости. По сути, это более крупные функции кода, которые вы, возможно, не захотите использовать в своей сети или в пространстве памяти.

```ini
[bbs]
enabled = False

[general]
DadJokes = False
StoreForward = False
```

### История
Команда `history` показывает последние команды, выполненные пользователем, а [`lheard`] отражает последних пользователей бота.

```ini
enableCmdHistory = True # включение команды history
lheardCmdIgnoreNodes = # список игнорируемых узлов для истории команд, например: 2813308004,4258675309
```

### Настройки Sentry
Sentry Bot обнаруживает любого, кто приближается к узлу-боту. Использует значение широты/долготы из настроек местоположения.

```ini
SentryEnabled = True # обнаруживать любого, кто находится рядом с ботом
emailSentryAlerts = True # если включен SMTP, отправлять оповещение на список email сисопов
SentryRadius = 100 # радиус в метрах для обнаружения кого-либо рядом с ботом
SentryChannel = 9 # время удержания, умноженное на секунды (20) сторожевого таймера
SentryHoldoff = 2 # канал для отправки сообщения при срабатывании сторожевого таймера
sentryIgnoreList = # список игнорируемых номеров узлов, например: 2813308004,4258675309
highFlyingAlert = True # Оповещение о высоко летящем узле
highFlyingAlertAltitude = 2000 # Высота в метрах для срабатывания оповещения
highflyOpenskynetwork = True # проверять в OpenSkyNetwork, если обнаружен высоко летящий объект, на предмет самолета
```

### Настройки E-Mail / SMS
Включение подключения через SMTP позволяет отправлять сообщения из сети «Светлячок» в SMTP. Термин SMS здесь используется для подключения через [email оператора](https://avtech.com/articles/138/list-of-email-to-sms-addresses/).

```ini
[smtp]
# включить или отключить модуль SMTP, минимум, необходимый для исходящих уведомлений
enableSMTP = True # включить или отключить модуль IMAP для входящей почты, еще не реализовано
enableImap = False # список Email сисопов через запятую, используется в настоящее время только в экстренном ответчике
sysopEmails =
# См. config.template для всех настроек SMTP
SMTP_SERVER = smtp.gmail.com
SMTP_AUTH = True
EMAIL_SUBJECT = Светлячок✉️
```

### Обработчик экстренных ситуаций
Перехватывает следующие ключевые слова ("emergency", "911", "112", "999", "police", "fire", "ambulance", "rescue"). Отвечает пользователю и привлекает внимание к текстовому сообщению в логах и через другую сеть или канал.

```ini
[emergencyHandler]
enabled = True # включить или отключить обработчик экстренных ситуаций
alert_channel = 2 # канал для отправки сообщения при срабатывании обработчика
alert_interface = 1
```

### Оповещения EAS
Чтобы оповещать в сети с помощью EAS API, вы можете установить каналы и включить проверку каждые 20 минут.

#### FEMA iPAWS/EAS и NINA
Использует США: SAME, FIPS, для поиска оповещений в ленте. По умолчанию игнорируются тестовые сообщения.

```ini
eAlertBroadcastEnabled = False # Трансляция оповещений правительства IPAWS/CAP
eAlertBroadcastCh = 2,3 # Каналы трансляции экстренных оповещений правительства IPAWS/CAP
ignoreFEMAenable = True # Игнорировать любой заголовок, содержащий следующий список слов
ignoreFEMAwords = test,exercise
# список кодов FIPS через запятую для запуска местного оповещения. найдите свои коды FIPS на https://en.wikipedia.org/wiki/Federal_Information_Processing_Standard_state_code
myFIPSList = 57,58,53
# найдите свой SAME https://www.weather.gov/nwr/counties список кодов SAME через запятую для дальнейшего уточнения местного оповещения.
mySAMEList = 053029,053073

# Чтобы использовать службы других стран, включите только одну необязательную службу
enableDEalerts = False # Использовать данные трансляции оповещений DE, см. шаблон для фильтров
myRegionalKeysDE = 110000000000,120510000000
```

#### NOAA EAS
Использует определенные широту и долготу бота для сбора данных из API. см. [Мониторинг файлов](#Мониторинг-файлов) для идей по сбору оповещений EAS с RTL-SDR.

```ini
wxAlertBroadcastEnabled = True # Трансляция оповещений EAS
wxAlertBroadcastCh = 2,4 # Каналы трансляции оповещений EAS
ignoreEASenable = True # Игнорировать любой заголовок, содержащий следующий список слов
ignoreEASwords = test,advisory
```

#### Данные об уровне рек и оповещения о вулканах USGS
Используя страницу данных о воде USGS, найдите устройство для измерения уровня воды, например, Columbia River at Vancouver, WA - USGS-14144700

Оповещения о вулканах используют широту/долготу для определения радиуса ~1000 км.
```ini
[location]
# Уникальные идентификаторы гидрологии USGS, LID или USGS ID https://waterdata.usgs.gov
riverList = 14144700 # пример устья реки Колумбия

# Оповещения о вулканах USGS Включить трансляцию оповещений о вулканах USGS
volcanoAlertBroadcastEnabled = False
volcanoAlertBroadcastCh = 2
```

### Настройки ретранслятора
Функция ретранслятора для двух разных узлов и перекрестной публикации сообщений. `repeater_channels` - это список каналов ретранслятора, которые будут приниматься и ретранслироваться на тот же номер канала на другом устройстве, узле или интерфейсе. Каждый узел должен иметь совпадающие номера каналов. Имена каналов и PSK не обязательно должны быть одинаковыми на узлах. Используйте эту функцию ответственно, чтобы избежать создания петли обратной связи.

```ini
[repeater] # модуль ретранслятора
enabled = True
repeater_channels = [2, 3]
```

### Настройки Ollama (LLM/AI)
Чтобы Ollama работала, командная строка `ollama run 'model'` должна работать правильно. Убедитесь, что у вас достаточно ОЗУ и ваш GPU работает должным образом. Модель по умолчанию для этого проекта установлена на `gemma3:270m`. Ollama может быть удаленной [Ollama Server](https://github.com/ollama/ollama/blob/main/docs/faq.md#how-do-i-configure-ollama-server), работает на pi5 8GB с временем ответа 40 секунд или меньше.

```ini
# Включить ollama LLM, подробнее на https://ollama.com
ollama = True # Используемая модель Ollama (по умолчанию gemma2:2b)
ollamaModel = gemma3:latest # Используемая модель Ollama (по умолчанию gemma3:270m)
ollamaHostName = http://localhost:11434 # экземпляр сервера для использования (по умолчанию локальная установка)
```

Также см. `llm.py` для изменения значений по умолчанию:

```ini
# Системные переменные LLM
rawQuery = True # если True, ввод отправляется в LLM в сыром виде, если False, он обрабатывается шаблоном meshBotAI

# Используется в шаблоне meshBotAI (устарело)
llmEnableHistory = True # включить историю для модели LLM для использования в ответах, увеличивает время вычислений
llmContext_fromGoogle = True # включить контекст из результатов поиска Google, помогает с точностью ответов
googleSearchResults = 3 # количество результатов поиска Google для включения в контекст, больше результатов = больше времени вычислений
```
Примечание для LLM в docker с [NVIDIA](https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/docker-specialized.html). Необходимо для контейнера с запущенным ollama.

### Мониторинг радио
Модуль, позволяющий подключать к боту радио, совместимое с Hamlib. При работе он будет отправлять сообщение на настроенный канал о том, что частота используется. **Требуется, чтобы hamlib/rigctld работал как служба.**

```ini
[radioMon]
enabled = True
rigControlServerAddress = localhost:4532
sigWatchBroadcastCh = 2 # канал для трансляции, может быть 2,3
signalDetectionThreshold = -10 # минимальный SNR, сообщаемый радио через hamlib
signalHoldTime = 10 # время удержания для высокого SNR
signalCooldown = 5 # следующие значения комбинируются для сброса монитора
signalCycleLimit = 5
```

### Мониторинг файлов
Некоторые заметки разработчика для идей использования.

```ini
[fileMon]
filemon_enabled = True
file_path = alert.txt
broadcastCh = 2,4
enable_read_news = False
news_file_path = news.txt
news_random_line = False # возвращать только одну случайную строку из файла новостей
enable_runShellCmd = False # включает запуск bash-команд, демо runShell.sh для sysinfo
```

#### Офлайн EAS
Для мониторинга EAS без подключения к Интернету см. следующие примечания:
- [samedec](https://crates.io/crates/samedec) - декодер на Rust, похожий на multimon-ng
  - [sameold](https://crates.io/crates/sameold) - транслятор сообщений SAME на Rust, похожий на EAS2Text и dsame3

пока нет примеров для этих инструментов

- [EAS2Text](https://github.com/A-c0rN/EAS2Text)
  - зависит от [multimon-ng](https://github.com/EliasOenal/multimon-ng), [direwolf](https://github.com/wb2osz/direwolf), [samedec](https://crates.io/crates/samedec)
- [dsame3](https://github.com/jamieden/dsame3)
  - имеет пример .ogg файла для тестирования оповещений

Следующая команда оболочки может передать данные с помощью [etc/eas_alert_parser.py](etc/eas_alert_parser.py) в alert.txt
```bash
sox -t ogg WXR-RWT.ogg -esigned-integer -b16 -r 22050 -t raw - | multimon-ng -a EAS -v 1 -t raw - | python eas_alert_parser.py
```
Следующая команда оболочки передаст данные с rtl_sdr в alert.txt
```bash
rtl_fm -f 162425000 -s 22050 | multimon-ng -t raw -a EAS /dev/stdin | python eas_alert_parser.py
```

#### Газета в сети «Светлячок»
Газета может быть создана внешними скриптами. Можно использовать Ollama для компиляции текста с новостных веб-страниц и записи в news.txt.

### Модуль приветствия новых узлов QRZ
Это не QRZ.com, это Q-код "кто меня вызывает", он будет отслеживать новые узлы и приветствовать их.
```ini
[qrz]
enabled = True # Приветствие QRZ для новых узлов
qrz_hello_string = "отправьте CMD или напишите мне в DM для получения дополнительной информации." # будет отправлено всем услышанным узлам один раз
training = True # Режим обучения не будет отправлять приветственное сообщение новым узлам, используйте это для наполнения базы данных
```

### Планировщик
В файле config.ini включите модуль.
```ini
[scheduler]
enabled = False # включить или отключить модуль планировщика
interface = 1 # канал для отправки сообщения
channel = 2
message = "Светлячок говорит Привет! Напишите в DM для дополнительной информации."
value = # значение может быть min,hour,day,mon,tue,wed,thu,fri,sat,sun
interval =  # интервал для использования, когда время не установлено (например, каждые 2 дня)
time = # время суток в формате 24:00, когда значение 'day' и интервал не установлен
```
Основное сообщение для трансляции можно настроить в config.ini. Для расширенных настроек см. mesh_bot.py в конце файла, строка [1491](https://github.com/SpudGunMan/meshing-around/blob/e94581936530c76ea43500eebb43f32ba7ed5e19/mesh_bot.py#L1491) для редактирования расписания. См. [документацию по schedule](https://schedule.readthedocs.io/en/stable/) для получения дополнительной информации. Рекомендуется делать резервные копии изменений, чтобы они не потерялись.

```python
#Отправлять WX каждое утро в 08:00 с помощью функции handle_wxc на канал 2 на устройстве 1
schedule.every().day.at("08:00").do(lambda: send_message(handle_wxc(0, 1, 'wx'), 2, 0, 1))

#Отправлять сообщение о начале сети каждую среду в 19:00 с помощью функции send_message на канал 2 на устройстве 1
schedule.every().wednesday.at("19:00").do(lambda: send_message("Сеть начинается сейчас", 2, 0, 1))
```

#### Связь BBS
Планировщик также обрабатывает сообщение о трансляции BBS Link, это пример того, как канал mesh-admin на 8 используется для передачи трафика постов BBS между двумя ботами в качестве инициатора, одностороннее получение.
```python
# Отправлять bbslink в поисках пиров каждые два дня в 10:00 с помощью функции send_message на канал 8 на устройстве 1
schedule.every(2).days.at("10:00").do(lambda: send_message("bbslink Светлячок ищет пиров", 8, 0, 1))
```
```ini
bbslink_enabled = True
bbslink_whitelist = # список разрешенных номеров узлов, например: 2813308004,4258675309, пустой список разрешает все
```

### Прошивка 2.6 DM Key и 2.7 CLIENT_BASE Избранные узлы
Прошивка 2.6 представила [PKC](https://meshtastic.org/blog/introducing-new-public-key-cryptography-in-v2_5/), обеспечив безопасный обмен личными сообщениями путем добавления необходимых ключей на каждый узел. Чтобы в полной мере использовать эту функцию, вы должны добавить избранные узлы — например, администраторов BBS — в список избранных вашего узла, чтобы их ключи сохранялись. Для упрощения этого процесса предоставляется вспомогательный скрипт:
- Запустите вспомогательный скрипт из основного каталога программы: `python3 script/addFav.py`
- По умолчанию этот скрипт добавляет узлы из `bbs_admin_list` и `bbslink_whitelist`
- Если вы используете виртуальную среду, запустите: `launch.sh addfav`

Чтобы настроить избранные узлы, добавьте их номера в ваш конфигурационный файл:
```conf
[general]
favoriteNodeList = # список номеров избранных узлов, например: 2813308004,4258675309, используется script/addFav.py
```

### Заметки по MQTT
В коде нет прямой поддержки MQTT, однако, по сообщениям из Discord, использование [meshtasticd](https://meshtastic.org/docs/hardware/devices/linux-native-hardware/) без радио и подключение бота к программному узлу, который связан с MQTT, позволяет маршрутизацию. Протестировано и полностью работает с прошивкой 2.6.11 с [mosquitto](https://meshtastic.org/docs/software/integrations/mqtt/mosquitto/).

~~Кажется, есть и более быстрый способ включить MQTT, если у вашего узла-бота включен модуль [serial](https://meshtastic.org/docs/configuration/module/serial/) с включенным эхо и MQTT uplink и downlink. Эти два~~

# Благодарности

Я использовал идеи и фрагменты кода из других ботов-ответчиков и хочу их отметить!

### Вдохновение и фрагменты кода
- [MeshLink](https://github.com/Murturtle/MeshLink)
- [Meshtastic Python Examples](https://github.com/pdxlocations/meshtastic-Python-Examples)
- [Meshtastic Matrix Relay](https://github.com/geoffwhittington/meshtastic-matrix-relay)

### Игры, портированные из
- [Lemonade Stand](https://github.com/tigerpointe/Lemonade-Stand/)
- [Drug Wars](https://github.com/Reconfirefly/drugwars)
- [BlackJack](https://github.com/Himan10/BlackJack)
- [Video Poker Terminal Game](https://github.com/devtronvarma/Video-Poker-Terminal-Game)
- [Python Mastermind](https://github.com/pwdkramer/pythonMastermind/)
- [Golf](https://github.com/danfriedman30/pythongame)
- Данные пула вопросов ARRL из https://github.com/russolsen/ham_radio_question_pool

### Особая благодарность
- **xdep**: За инструменты отчетности.
- **Nestpebble**: За новые идеи и улучшения.
- **mrpatrick1991**: За конфигурации Docker.
- **[https://github.com/A-c0rN](A-c0rN)**: Помощь с iPAWS и EAS
- **Mike O'Connell/skrrt**: За [eas_alert_parser](etc/eas_alert_parser.py), улучшенный **sheer.cold**
- **PiDiBi**: За просмотр тестовых функций и другие предложения, такие как wxc, использование ЦП и идеи оповещений.
- **WH6GXZ nurse dude**: За "башинг" установщика, оповещения о вулканах 🌋
- **Josh**: За еще больший "башинг" установщика!
- **dj505**: за попытку запустить на windows!
- **mikecarper**: идеи и тестирование. hamtest
- **c.merphy360**: оповещения о большой высоте
- **Iris**: тестирование и поиск 🐞
- **Cisien, bitflip, **Woof**, **propstg**, **trs2982**, **Josh** и Hailo1999**: За тестирование и идеи по функциям в Discord и GitHub.
- **Сообщество Meshtastic в Discord**: За подкидывание идей и тестирование кода.

### Инструменты
- **Управление резервным копированием узлов**: [Node Slurper](https://github.com/SpudGunMan/node-slurper)

### Требования
Требуется Python 3.8 или новее (docker на 3.13). Следующее можно установить с помощью `pip install -r requirements.txt` или с помощью скрипта [install.sh](install.sh) для виртуальной среды и автоматизации:

```sh
pip install meshtastic
pip install pubsub
```

Улучшения для меш-бота:

```sh
pip install pyephem
pip install requests
pip install geopy
pip install maidenhead
pip install beautifulsoup4
pip install dadjokes
pip install schedule
pip install wikipedia
```

Для Ollama LLM:

```sh
pip install googlesearch-python
```

Чтобы включить эмодзи в консоли Debian, установите шрифты:

```sh
sudo apt-get install fonts-noto-color-emoji
```

Meshtastic® является зарегистрированным товарным знаком Meshtastic LLC. Программные компоненты Meshtastic выпускаются под различными лицензиями, подробности см. на GitHub. Гарантия не предоставляется - используйте на свой страх и риск.